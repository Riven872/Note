### 需求

#### :full_moon:一、新增航司里程会员权益

1. **航司里程发放策略配置和管理**
    1. 疑问：
        1. 在系统里添加了这些配置后，哪些业务会用到，怎么用到（即什么场景下会调用、触发该功能），目前的理解是根据权益在积分下发时会调用到该接口，查询发放的配置。
    2. QA：
        1. 会在权益生效且订单符合要求时查询该配置，进行航司积分的发放。
        2. 订单触发条件要接口查枚举类，比如要求出行完成之后才能触发或者出行完成之后发一部分或订单提交时就可以发放等。
        3. 发放一致性：航司账户姓名 = 出行人姓名
        4. 出行人一致性：航司账户姓名 = 出行人姓名
        5. 出行航司一致性：航司名称 = 发放航司
        6. 运营文档中给出的发放系数已经是金卡标准，因此只需关心单位消费金额和单位积分即可，会员等级的优惠运营会自己调整配置的单位消费金额。
    3. 在航司管理菜单下配置二级菜单 -> 航司积分配置
    4. 数据库表字段：航司 ID、航司名称、会员等级、上限额度、发放条件、是否发放一致性、是否出行人一致性、是否航司一致性、实付最小单位金额、发放最小单位积分、风控策略 ID、标准字段
    5. 展示字段：航司 ID、航司名称、会员等级、上限额度、发放条件、是否发放一致性、是否出行人一致性、是否航司一致性、实付最小单位金额、发放最小单位积分、风控策略 ID、创建者（创建时间）、更新者（更新时间）
    6. 新增两个字段（C 端会维护）：
        1. 奖励名称 - point_name varchar(50)
        2. 奖励单位 - point_unit varchar(50)
        3. 如，东方航空的积分叫：东方万里行积分，因此积分名称是东方万里行，单位是积分。中国国际航空的积分叫：凤凰知音里程，因此积分名称是凤凰知音，单位是里程
    7. ~~航司积分奖励规则 = [实付金额 / 不同航司的消费最小单位 * 航司里程奖励最小单位 * 会员等级系数]，得到的结果去除小数并在十位向上取整（对 10 取模 + 10 - 模的部分就是最终奖励积分）~~
    8. ~~数据库表字段：航司 ID、航司名称、会员等级、上限额度、消费最小单位、奖励最小单位、（里程触发发放条件）、是否发放一致性、是否出行人一致性、是否出行航司一致性、（发放系数）、风控策略 ID~~
    9. ~~展示字段：与数据库表业务字段相同~~
2. 后台查询权益发放情况
    1. 在商城系统 - 航司管理模块下新增菜单
        1. 用户权益发放明细（航司积分发放明细）
            1. 查询条件：memberid、unionid、订单号、绑定航司
            2. 展示字段：会员 ID、会员等级、订单号、订单实付金额、绑定航司、里程奖励数、发放状态
        2. 用户权益统计信息（航司积分绑定记录）
            1. 查询条件：memberid、unionid、绑定航司
            2. 展示字段：会员 ID、会员等级、航司会员卡号、航司用户名、~~等级周期~~、绑定航司、配置额度、已发额度、锁定额度、可用额度、全局用度（其中额度字段需要自己计算）
            3. 锁定额度：需要根据 state = 0 和当前用户的 user_key 同一个 airlineName 查询 airline_point_record 表中的 point 的总和
            4. 全局额度（百分比）：（已发额度 + 锁定额度）/ 配置额度
            5. 可用额度：配置额度 *（1 - 全局用度）
        3. 数据库表：TCMemberWCRewardshop
            1. airline_bind_record - 航司积分绑定记录表
            2. airline_point_record - 航司积分发放明细表
    2. 对用户进行补发航司里程操作
        1. 在订单明细中添加功能，运营在点击时可以对该订单进行积分的补发。
        2. airline_point_record - 航司积分发放明细表新增字段【补发积分】 addition_point，记录补发的部分，弹框提示输入补发积分，并后台校验不可大于当前订单的实付金额且为正数，前端校验不可以输入负数。需要二次弹框校验。



#### :zap:[二、里程优享卡提供外部里程额度相关接口](https://matrix.17usoft.com/v2/matrix-web/project/pjt2060#/requirementPool/219377)

1. 背景
    1. 会员权益中心 - 资源管理 - 第三方账号：可以配置里程优享卡的活动 ID
    2. 里程优享卡会提升每次订单用里程抵扣的额度，且可以充值里程。
    3. 目前只有火车票的优享卡，因此根据账户查询时也只会查询出火车票相关的优享卡，之后会对接机票、酒店等 BG 优享卡的使用，因此需要改造成以消耗活动 ID 为维度的查询。
    4. 调用链路： /member/info -> /account/queryDetail，可以获取【剩余可用额度】
2. 开发
    1. 分支：feature/zz/memberInfoAddParam
    2. 项目：member-center -> member-center-open-api
    3. 修改接口：/membercenteropenapi/member/info
    4. 在 /member/info 接口中新增参数，传递给下游的  /account/queryDetail
    5. 参数：`payActivityId Integer 里程扣减活动 ID 必填`



#### :full_moon:[三、里程卡券码一键发送企业邮件](https://www.wulihub.com.cn/gc/JPKw8w/index.html?de=94bc#g=1&p=%E7%AD%89%E7%BA%A7%E5%88%B8%E7%A0%81%E5%90%8E%E5%8F%B0)

1. 关联关系
   1. 业务载体类型规定了单位的业务，业务载体是在业务载体类型的基础上进一步进行细分和配置。业务载体类型 -> 业务载体。
   2. 券码批次只是规定了一定数量的券，每一张券会有券码明细来细分。券码批次 -> 券码明细（单个原子券码）
2. 背景
   1. 在渠道配置中添加新配置时，可以相应的添加该渠道的电子邮箱联系地址。然后在券码批次管理中点击对应批次发送邮件时，根据渠道 code 找到相对应的电子邮箱地址。
   2. 在第三方渠道表中 bus_channel 新增字段：企业电子邮箱（emailAddress）、企业编码（对应载体一级归因）（enterprise_code）
   3. 发送邮件需要置当前批次有效，因此发送时传入主键 ID 调用该方法即可 `com.ly.member.service.coupon.impl.CouponBatchServiceImpl#updateValid`
   4. 在点击按钮时，服务端要做校验限制：券码批次下所有券码都要未激活且未注销且券码数量与券码批次生成的明细数量一致
      1. 一个券码批次会生成多个券码明细
      2. 根据券码批次（batch_code）查询对应的券码明细，遍历明细必须所有的券码都要未激活且未注销，且明细数量应与券码批次规定的数量一致。
   5. 发送企业邮件按钮显示条件：当前行的业务载体类型 = 里程优享卡
   6. 附件名称、附件文件表头所需字段查表：TCWirelessMemberCenterWeChat - tb_coupon_batch
   7. 在生成文件附件时，直接通过文件流的方式作为邮件附件，不经过硬盘，直接在内存中处理
   8. 置有效和导出状态需要在所有的流程结束之后最后去做，防止事务的单独触发。
      1. 其中导出状态在添加附件的时候会有操作置为已导出
   9. 附件：
      1. 附件名称（从指定的券码批次中取值即可）
         1. 公司名称：根据批次中的渠道 code 找到 bus_channel 表中的 channel_name
      2. 附件表头（TEMemberCenterWeChatPayment 库）
         1. 券码：根据批次的 batch_code 找到 tb_grade_coupon_code 表中所有的 coupon_code
         2. 公司枚举值：根据批次中的渠道 code 找到 bus_channel 表中的 enterprise_code
         3. 渠道号：根据批次的主键 ID 找到 tb_coupon_batch 表中的 channel_code
         4. 其中拼接地址中的公司枚举值需要用 URL 编码
         5. 有效期起始、截止时间：取 tb_grade_coupon_code 表中的 expiration_starttime、expiration_endtime
      3. 需要校验附件大小，不超过 5M，若每个文件超过 5000 条，则需要新增文件
3. 开发
   1. 分支：feature/zz/SendEmailByCoupon
   2. 项目：
      1. member-center-admin
      2. member-center-user-api-service
   3. 数据库表：
      1. TCWirelessMemberCenterWeChat
         1. bus_channel：渠道（新增字段：email_address、enterprise_code）
         2. tb_coupon_batch_history：券码批次历史记录（新增字段：zone_id）
         3. tb_coupon_batch：券码批次（新增字段：zone_id）
   4. 应用标识：
      1. 会员 API - tcwireless.java.member.center.userapi
      2. 会员中心管理系统 - tcwireless.java.member.center.web



#### :full_moon:四、[【联名会员】联名会员需求迭代](https://matrix.17usoft.com/v2/matrix-web/project/pjt2060#/requirementPool/220535)

1. :full_moon:联名会员 - 集团列表
   1. 详情页：
      1. 新增字段：排序（必填、正整数、越大排序越靠前）
   2. 列表页：
      1. 新增字段：排序（降序排列分页数据）
   3. 该配置会影响用户端的展示
2. :full_moon:联名会员 - 集团列表 - 配置权益
   1. 详情页：
      1. 新增字段：排序
   2. 列表页：
      1. 新增字段：排序
      2. 分页数据以倒序返回
   3. 该配置排序​同样会影响用户端的展示顺序
   4. 集团与权益之间通过集团标识进行关联
3. :full_moon:小程序 - 权益浮层 - 联名会员卡 - 酒店会员
   1. 酒店会员对应后台配置的集团列表，按照后台配置的排序规则展示。
   2. 展示逻辑修改
      1. 原逻辑为，根据联名会员的最小等级展示
      2. 查出所有联名会员的数据、所有联名会员的映射数据，其中映射数据根据用户等级进行筛选，只保留符合当前用户等级的数据。然后将两个集合中的 company_ident 比对，取交集，交集结果字段为联名会员的数据。酱就根据等级筛选完毕。其余逻辑不变.
4. :full_moon:联名会员 - 用户互通数据
   1. 详情页：
      1. 新增字段：激活来源
      2. 数据来源于数据买点时传入的 refId，直接展示 refId 即可
5. :full_moon:数据埋点：
   1. 用户端联名会员激活集团权益时，激活按钮触发的接口进行埋点，将 refId 落表
      1. 接口地址：`memberexchange/submitExchangeInfo`
6. :full_moon:联名会员 - 更多推荐
   1. 有效无效滑块变动时，同步用户端展示与否
   2. 更多推荐需要与同程会员、配置平台挂钩，可以复用配置等级的逻辑、配置平台的逻辑。
      1. 配置平台复用 ME_CompanyPlatform 表，company_ident 字段同样用来存推荐卡标识
      2. 配置等级复制集团关联的等级映射菜单，新增推荐卡等级映射菜单
7. :full_moon:小程序 - 权益浮层 - 联名会员卡 - 其他会员
   1. 其他会员对应后台配置的其他更多推荐
   2. 只根据用户的会员等级展示出相应的会员
8. 开发：
   1. 分支：feature/zz/CompanyMember
   2. 数据库表：
      1. TCWirelessMemberCenterWeChat
         1. ME_CompanyInfo：集团列表页（新增字段：sort_id）
         2. ME_WelfareMapping：集团关联的权益（新增字段：sort_id）
         3. ME_CompanyPlatform：集团关联的外显平台
         4. ME_MemberLevelMapping：集团关联的会员等级映射
         5. ME_RecommendCard：更多推荐
         6. tb_member_exhange_record：联名会员用户互通数据（新增字段：refId）
   3. 应用标识：
      1. tcwireless.java.member.center.web - 会员后台
      2. tcwireless.java.member.center.userapi - 用户端会员 API
   4. 新增菜单：推荐卡等级映射



#### :moon:五、权益卡外部接口能力

1. :full_moon:新增外部接口：查询用户等级卡、权益卡激活记录明细
   1. 入参：用户账号（memberid、unionid）、券码编码
      1. 二者必填一个字段
   2. 出参：用户账号、激活时间、活动类型【0 - 等级卡 | 1 - 权益卡】、渠道名称、渠道编码、批次编码、券码编码、激活状态【0 - 激活成功 | 1 - 激活失败】、激活失败原因、激活时使用的手机号、渠道三级归因
      1. 按最近激活时间降序排序（ES 中默认就是这个排序规则）
      2. 返回 List，如果按照券码查询，则 List 中只有一条数据
      3. 渠道三级归因需要关联查询
      4. 枚举字段对应值需要开发的时候再核对一下
   3. 步骤：
      1. 先查 mysql 中的渠道表，把所有 valid 的数据放入内存，需要组装成 map，key = 渠道编码（channel_code），value = 三级归因（third_dimension）
      2. 再查 ES，把符合条件的数据放入内存，并根据数据的渠道编码去 map 中找到对应的三级归因。
      3. ES + 三级归因组装成返回值 List。
2. 开发：
   1. 分支：feature/zz/ExperienceCardOpenAPI
   2. 数据库表：
      1. TCWirelessMemberCenterWeChat
         1. tb_experiencecard_coupon_batch：权益卡券码批次
         2. tb_coupon_batch：等级卡券码批次
         3. bus_channel：第三方渠道表
   3. ES 索引：
      1. couponcode-activationrecord：激活失败的券码（包括等级卡和权益卡）
   4. 应用标识：
      1. tcwireless.java.member.center.openapi - 会员开放平台api
   5. 额外：ES 索引中已经有全量的字段，不需要再查询 MySQL 中的渠道表



#### :full_moon:六、商城首页改版

1. :full_moon:新增公告管理菜单列表页
   1. 商城管理系统 - 公告管理
   2. 展示聚合公告及公告投放平台
2. :full_moon:新增公告管理详情页
   1. 商城管理系统 - 公告管理 - 详情页
   2. 修改公告
3. :full_moon:新增公告管理配置投放平台详情页
   1. 商城管理系统 - 公告管理 - 平台管理
   2. operation_notice_platform 的增删改查
   3. 相当于挂在公告管理下的一个平台明细
4. :full_moon:商城管理系统 - ​​广告管理 - 推荐活动板块
   1. 新增列表页：展示字段见库表
      1. 操作：修改、删除、配置展示平台
      2. 配置展示平台与公告功能类似
   2. 新增详情页：
      1. 操作：修改详情页
5. :full_moon:商城管理系统 - 广告管理 - 推荐活动
   1. 新增列表页：展示字段见库表
      1. 操作：修改、删除、配置展示平台
      2. 配置展示平台功能类似
      3. 推荐活动板块需要与推荐活动关联，是父子关系
   2. 新增详情页：
      1. 操作：修改详情页
   3. 推荐活动板块是配置整一个板块，推荐活动是这个板块中的各个具体活动
6. 开发：
   1. 分支：feature/zz/NewMemberMallAdmin
   2. 数据库表：
      1. TCMemberShop
         1. operation_notice - 公告内容：新增表
            1. title 字段显示给后台看
            2. content 字段显示给用户端看
         2. operation_notice_platform - 公告内容关联的投放平台：新增表
         3. index_module - 推荐活动板块：新增表
         4. index_module_platform - 推荐活动板块投放平台：新增表
         5. index_module_item - 推荐活动：新增表
         6. index_module_item_platform - 推荐活动投放平台：新增表
7. 应用标识：
   1. tcwireless.java.member.shop.admin - 商城后台
8. 新增菜单：
   1. 首页管理 - 公告配置
   2. 首页管理 - 推荐活动板块管理
9. bug
   1. 首页管理 - 公告配置 / 推荐活动板块管理
   2. 推荐活动不需要单独一个列表页，直接跳转即可
   3. 模块 ID 做成下拉形式
   4. 排序的提示语优化
   5. 所有时间把时分秒放出来、且校验
   6. 根据先知 ID 查询出人群的下拉框
   7. 类型字段加筛选
   8. 平台 CODE 是下拉，且不需要显示创建、修改时间等字段，且相同平台不可同时选择。平台 CODE、文案需要必填
   9. 版面字段优化
   10. 接口权限



#### :full_moon:[七、航司付费权益卡 - 一期](https://matrix.17usoft.com/v2/matrix-web/project/pjt2060#/requirementPool/224985?edit=false)

1. 小程序 - 航司权益开卡页
   1. 接口：获取航司权益卡数据 0.5
      1. 根据跳转页面传入的参数查询选择的航司权益卡并置首位
      2. 查询当前用户所有的航司权益卡（已购、生效、有效期升序，不展示待付款、已生效的卡）
      3. :moon:特殊场景：根据账号是否绑定决定是否分平台展示还是合并配置成一张卡
   2. 接口：查询权益包中的所有最新权益 0.2
   3. 接口：查询权益卡售价价格 0.3
      1. 首先校验当前账号是否已经购买了当前批次的权益卡，若已购买则直接返回而不是返回价格
      2. 根据用户身份和配置的付费权益卡得出当前航司权益卡的价格
   4. 接口：购买权益卡 2
      1. 查询账户里程余额，不足则抛出异常拦截购买
      2. 可以购买时走支付流程，并做相应里程的扣减
      3. 支付完成后走回调，财务接口校验支付状态并将支付结果（状态）落表
2. 小程序 - 航司权益领取页
   1. 接口：领取航司积分 1.5
      1. 校验当前账号是否绑定航司，若没有绑定需要对接航司账号绑定接口
      2. 调 ERP 接口将航司积分充值到对应的账户中
      3. 将充值动态发送到 MQ 中，MQ 消费成功后变更资源的充值状态（充值成功或失败都会进行状态的变更）
   2. 接口：领取 ERP 券包 0.5
      1. 调用 ERP 优惠券领取接口后，变更权益领取状态
3. 小程序 - 航司权益领取记录页
   1. 接口：查询全量航司卡的已领权益 0.3
      1. 按照当前登录账号筛选航司权益卡关联的领取记录，按资源发放时间升序排列
   2. 接口：查询单条权益 0.2
      1. 根据后台配置的航司权益卡配置信息展示
4. 小程序 - 购卡订单记录页
   1. 接口：查询购卡订单记录 0.5
      1. 下单后生成订单记录，在新配置的后台中可见订单记录
      2. 查询后台配置的权益卡订单记录
5. 会员管理后台 - 付费权益卡管理 - 卡信息列表 1
   1. 新增列表页：展示字段见 prd
      1. 筛选条件：卡面编码、卡面名称、业务载体 code、业务载体名称、业务载体类型
   2. 新增详情页：
      1. 板块零：卡基本信息 + 业务载体 code、业务载体名称、业务载体类型
      2. 板块一：背景图、背景色值、活动规则链接、卡开通前主图、卡开通后主图
      3. 板块二：支付收款信息
      4. 板块三：价格信息
      5. 板块四：库存信息
      6. 操作：可编辑
6. 会员管理后台 - 付费权益卡管理 - 订单明细 1
   1. 新增列表页：字段见 prd
      1. 操作：申请退款
         1. 当前订单明细逆向、涉及的里程数量退回
      2. 操作：已领权益
         1. 根据筛选参数跳转至：资源管理 - 权益资源领取记录，并根据携带的参数自动筛选出符合条件的权益
7. 开发：
   1. 分支：feature/zz/AirlineCardV1
   2. 消息队列：
      1. QA：
         1. topic：marketing_java_center_topic_welfarecard_order
         2. group：marketing_java_center_welfarecard_order_delay_group
   3. 数据库表：
      1. TCWirelessMemberCenterWeChat
         1. welfarecard_info - 权益卡信息：新增表
            1. 卡面编码、卡主标题、卡副标题、卡角标文案、卡名称、售卖开始时间、售卖结束时间、排序、风控 ID、等级限制值、背景图 url、背景色值、活动规则链接 url、卡开通前主图 url、卡开通后主图 url、业务载体 code、业务载体名称、业务载体类型
         2. welfarecard_info_pay - 权益卡收款信息：新增表
            1. 支付渠道类型【1 - 微信 | 2 - 支付宝】、支付方式类型、里程消耗活动 ID、APP 收银台项目编码、微信收银台项目编码、商户号、收款方名称、底部支付协议名称、底部支付协议链接、支付按钮文案、支付按钮角标
         3. :moon:welfarecard_info_price - 权益卡价格信息：新增表
            1. 市场价、标准售价、实付价、等级价、里程价、价格类型【0 - 标准售价 | 1 - 等级价 | 2 - 先知价 | 3 - 限时价】
         4. welfarecard_info_stock - 权益卡库存信息：新增表
            1. 卡库存数量、总库存数量、每日库存数量、日购买上限、月购买上限、年购买上限、持有上限
         5. welfarecard_order - 权益卡订单：新增表
            1. 订单号、ERP 资源订单号、用户账号、卡面编码、业务载体 code、卡名称、下单平台类型、订单状态（需要增加一个是否退款）、支付流水号、订单实付金额、订单实付里程、里程状态、航司名称、充值状态、充值失败原因、充值账号、充值航司积分、支付渠道号、支付渠道类型、支付渠道名称
         6. :moon:welfarecard_order_info - 权益卡订单明细：新增表
            1. 考虑是否将权益卡订单中的付款信息字段拆到该表中
         7. welfarecard_order_refund - 权益卡订单退单明细：新增表
            1. 订单号、退单号、退款状态、退款流水号
   4. :full_moon:付费权益卡菜单 - 卡面信息配置
      1. 新增列表页
         1. 复制：
            1. 卡面信息和价格信息一并复制，需要生成新的卡面编码，新增的卡面价格需要重新指向新的卡面信息（cardId、cardCode）
         2. 修改、删除：
            1. 常规操作
      2. 新增详情页：
         1. 卡面编码用指定的规则自动生成
         2. 载体类型 code 和业务载体 code 要在后台手动绑定
         3. 详情页的信息是两张表的聚合，注意后台返回的 DTO
   5. :full_moon:付费权益卡菜单 - 集合页配置（每个集合页理解为一个专区或者是一个推荐活动）
      1. 新增列表页
         1. 有效性操作
         2. 关联权益卡
            1. 点击后带集合页参数跳转至关联权益卡页面
   6. :full_moon:付费权益卡菜单 - 关联权益卡（不外显，只做跳转使用）
      1. 展示所有当前集合页关联的所有权益卡：卡面编码、载体类型、业务载体、主标题、副标题
      2. 添加权益卡
         1. 点击后展示列表，显示所有的权益卡，可选多个进行集合页与权益卡的绑定
         2. 展示的列表筛选项 ：载体类型（下拉框）、业务载体（关联下拉）
   7. 数据库表 v2：
      1. TCWirelessMemberCenterWeChat
         1. welfarecard_info - 权益卡信息：新增表
            1. 卡面编码、卡主标题、卡副标题、卡角标文案、卡名称、售卖开始时间、售卖结束时间、排序、风控 ID、等级限制值、卡专区 ID、卡开通前主图、卡开通后主图、支付方式类型、支付协议名称、支付协议链接、里程消耗活动 ID、卡持有上限、订单支付时间、同一个业务载体的购买上限、开卡后的退款有限期、业务载体信息 code、载体类型 code、总库存数量、每日库存数量、有效性、标准字段、航司 ID、航司名称
         2. welfarecard_price - 权益卡价格信息：新增表
            1. 卡标识、市场价格、标准售价、标准支付里程、价格类型、先知 ID、先知人群 key、先知人群 value、会员等级、有效性、标准字段
         3. welfarecard_zone - 权益卡专区基础信息：新增表
            1. 专区 code、头图、背景色值、活动链接
         4. welfarecard_zone_bind - 权益卡专区绑定信息：新增表
            1. 专区 code、卡面编码
   8. 应用标识：
      1. tcwireless.java.member.shop.admin - 商城后台
      1. 
   9. 新增菜单：
      1. 会员管理后台 - 付费权益卡管理 - 卡信息列表
      2. 会员管理后台 - 付费权益卡管理 - 集合页配置
      3. 会员管理后台 - 付费权益卡管理 - 订单明细
8. 中间件：
   1. 需要增加 topic 监听订单回调与信息
9. 风险点：
   1. 权益卡内容较多，因此主表下会有多个明细表，需要讨论一下根据业务是否需要合并表，担心合并之后会变成大宽表，还是需要根据实际的业务考量
   2. 每次在用户端查询当前用户下单时，要做好防止重复下单的处理，考虑将用户下单信息放入 Redis 快速查询，加锁处理，但是需要兜底方案，防止中间件不可用导致的用户下单信息丢失
10. 随手记：
    1. :full_moon:库存数量配置需要在卡面信息上记录
    2. 支付渠道不需要配置，但是用户支付完之后的回调需要记录用户的支付方式
    3. 里程消耗活动 token 直接在代码里写死，不落库，用枚举值记录即可
    4. 流程
       1. 载体类型规定一个业务大类，业务载体对载体类型进行进一步细化的配置
       2. 权益分类规定一个权益大类，权益配置对权益分类进行进一步细化的配置
       3. 资源基础信息中，配置资源的类型和来源，此处的资源可与 ERP 的资源关联（关联 ERP 的）
       4. 新增策略管理时，将权益配置的信息与绑定的资源联系在一起。同时可以进行操作，将业务载体也关联起来（所有东西包起来的）
    5. cacheClientHALock.String().setnx()，多线程来时如果没有获取到锁，不会阻塞，也不会再次尝试获取锁
    6. DistributedUtil.tryLock(keyLock)，多线程来时如果没有获取到锁，会阻塞当前线程并尝试获取 10s 每 30ms 尝试一次



#### :full_moon:八、星耀需求 - 一期

1. 会员后台 - 用户管理 - 新增白名单激活列表页
   1. 按钮 - 新增星耀：
      1. 弹窗填写信息，调用激活方法。其中弹窗会填写用户账号（mid、uid、手机号），有关联关系则全部激活，无关联关系跳出
      2. 根据手机号查 memberId，并查是否已经激活，若未激活再用 unionId 查是否激活，如果都未激活，则同时调用激活方法。因此如果没有绑定关系，两个平台会存在不同的会员等级情况。
      3. 已激活用户列表可查表：star_member_info，通过给 channel 赋值为特定的字符串，标记该激活用户是白名单激活且是否需要自动续期
   2. 新增按钮 - 批量激活星耀会员：
      1. 导入未激活的账号，批量激活也使用 `activateByOther` 方法
      2. 导入 excel 文档功能可参考页面：等级券码管理 - 券码礼品卡活动 - 导入 Excel 文件按钮
      3. 导入的表头：账号、账号类型、到期时间、是否自动续期
      4. 导入失败后的表头：账号、账号类型、到期时间、是否自动续期、失败原因
2. 会员后台
   1. 新增列表页 - 未激活星耀账号
      1. 列表页展示所有符合激活条件但未激活的账号（star_member_info 表中 state = 0 代表符合条件但未激活）
   2. 列表页功能
      1. 导出
3. JOB
   1. 每天扫描一次所有已激活且白名单激活且自动续期的账户，如果临期进行自动续期
4. 开发：
   1. 分支：feature/zz/StarVipV1
   2. 数据库表：
      1. star_member_info：星耀会员信息表
      2. star_sync_temp：星耀会员同步表
   3. 新增 job：
      1. 自动续期：`http://tourwirelessapi.qa.17usoft.com/membercenterjob/star/autoRenewal`
   4. 后台菜单：
      1. 会员后台 - 用户管理 - 星耀白名单激活
      2. 会员后台 - 用户管理 - 邀请星耀白名单
   5. 应用标识：
      1. tcwireless.java.member.center.web
      2. tcwireless.java.member.center.job



#### :full_moon:九、星耀需求 - 二期

1. :full_moon:会员后台 - 用户管理 - 星耀明细
   1. 新增列表页
      1. star_member_info 全量数据，不区分渠道和状态
   2. 列表页按钮：
      1. 导出
      2. 单个或批量失效
2. :full_moon:新增 JOB：
   1. 每天执行一次，如果星耀会员过期时，变更状态，并发送先知消息
3. :full_moon:修改 JOB：
   1. 在统一配置中添加单日 sync -> info 表的同步数量阈值，达到阈值时不执行今天的同步操作，并通过机器人发送消息
4. 开发：
   1. 分支：feature/zz/StarVipV2
   2. 数据库表：
      1. star_member_info：星耀会员信息表
   3. 新增 job：
      1. 自动过期：`http://tourwirelessapi.qa.17usoft.com/membercenterjob/star/autoExpire`
5. 后台菜单：
   1. 会员后台 - 用户管理 - 星耀明细
6. 统一配置：
   1. star_vip_sync_threshold = 1000
7. 应用标识：
   1. tcwireless.java.member.center.web
   2. tcwireless.java.member.center.job



#### :full_moon:十、星耀需求 - 权益（0 元酒店）

<div>
<del>
1. 小程序 - 会员中心 - 可享权益（权益列表页）
   1. 接口地址：`/membercenteruserapi/welfare/getCategoryWelfares`
   2. 展示数量去除生日礼包
2. 小程序 - 会员中心 - 会员权益（tab）
   1. 接口地址：`/membercenteruserapi/welfare/getAggregateWelfares`
   2. 展示的会员权益去除生日礼包
</del>
</div>
1. 随手记：
   1. :zap:领取过二选一的存量用户
      1. 领过机场贵宾厅的，不保留2选1样式，正常展示贵宾厅权益
      2. 领过0元酒店的，不保留2选1样式，等级有效期内贵宾厅次数展示为0
   2. :zap:艺龙酒店侧订单状态变更监控
      1. 可以参考 ERP 监听券状态变更的 MQ，会员侧接一下订单状态的变更
   3. 进入权益详情页时，会调用 `/membercenteruserapi/welfare/getWelfareInfo` 接口查询权益的相关信息，并提前进行逻辑的校验，由前端获取参数并处理（因此这个接口不单单是获取权益的详细信息，还会校验当前用户之于当前权益的关联，如当前账号的次数等）
   4. 在权益详情页领取权益时，才会去调用 `/membercenteruserapi/welfare/writeOffWelfare` 接口去走领取权益的动作，但是领取前需要自己去发载体
2. :zap:配置项
   1. How to 配置，得向运营学学
3. :full_moon:领取校验：
   1. 领取权益接口 `/membercenteruserapi/getWelfareInfo` 传 0 元酒店的 welfarecode，即为 0元酒店权益，进行特殊校验处理
   2. 查询用户里程余额进行校验，若用户里程小于 9000 则拦截并返回当前用户的额度（mileageBalance）
   3. 实名三要素校验，`getThreeAuthInfo` 传入当前登录的账号进行校验，若为空则用户没有校验，让前端跳转至实名页面，若不为空则返回当前用户的实名信息（threeAuthInfo）
   4. 若校验通过则正常走`/membercenteruserapi/getWelfareInfo` 接口的返回值
   5. 权益详情接口新增字段
      1. mileageBalance - 用户里程余额
      2. mileageCreditLimit - 权益授信里程数
      3. needThreeAuth - 是否需要三要素
4. :full_moon:发券：
   1. :full_moon:通过 `getThreeAuthInfo` 查询实名信息，把实名信息继续透传到 ERP 层面（再从 ERP 到艺龙层）
   2. ~~在 `writeOff_carrierWelfare` 接口中根据 0 元酒店权益发载体~~ 该权益属于会员体系，因此不用发载体
   3. :full_moon:在 `WriteOffWelfareCommon` 方法中发放权益并写入领取记录的同时，扣除里程，将扣除里程的 detailid 记录下来，给后面核销动作使用。发权益时会同步的扣除里程，然后再发资源，因此扣里程的落表操作只能记录在 tb_user_welfare_record 表中
   4. :full_moon:`Erp_ExchangeStrategy` 策略中的发放资源动作 `sendResource`，调用 ERP 时，查三要素实名，不使用前端的实名信息
5. 核销：
   1. tb_user_resource_detail_record、tb_user_resource_record、tb_user_welfare_resource_record、tb_user_welfare_record
   2. 目前会员侧已经在监听 ERP 传过来的券核销信息，其中 type = 7 则标识该券来源是艺龙会
   3. ~~当券核销 3 天或离店状态 7 天后，里程返还~~
   4. 券核销：根据用户账号和 0 元酒店权益 UUID 查询 tb_user_welfare_record 表，得到核销状态和授信里程。如果该条记录的里程退还记录是未退还，则进行里程的退还
   5. 订单离店：非离店状态消息进行丢弃（status != 4）根据消息体中的券码查询 tb_user_resource_record 获取对应的资源 ID 和用户账号，再根据资源 ID 和用户账号查询 tb_user_welfare_resource_record 获取对应的权益 ID，最后根据权益 ID 和用户账号查询 tb_user_welfare_record 获取退还标识
   6. ~~根据券码查询 tb_user_resource_record 是否已核销，如果已核销且查询 tb_user_welfare_resource_record 退还记录为 true，则说明已经退还了里程。若未核销则获取该条记录的用户账号、授信里程、里程 ID 进行退还。不会产生重复退还的情况，如果订单先离店退还了里程，券核销退还时再次调用里程退还接口不会重复退还~~
   7. tb_user_welfare_resource_record 表中新增退还标识，券核销或订单离店时先校验该标识
   8. tb_user_welfare_resource_record 和 tb_user_resource_record 都需要新增字段：detailId、mileageCreditLimit、mileageCreditReturnFlag
6. 开发：
   1. 分支：feature/zz/StarVipWelfare
   2. 配置文件：
      1. user-api
         1. 0 元酒店权益 code 线下：zero.hotel.welfare.code=todo
         2. 0 元酒店权益 code 线上：zero.hotel.welfare.code=MSMI241211cf46d1dd34a94b869365b4ad797549f4
         3. 里程查询接口 线下：mileage.query.url=http://member.qa.17usoft.com/wxcoinapi/account/query
         4. 里程查询接口 线上：mileage.query.url=http://member.17usoft.com/wxcoinapi/account/query
         5. 0 元酒店扣除授信里程 token 线下：zero.hotel.welfare.pay.mileage.token=a2044d28-4579-4658-bb7d-871d77983cc7
         6. 0 元酒店扣除授信里程 token 线上：zero.hotel.welfare.pay.mileage.token=0fe4b402-6289-4931-89cc-16e1f00f792d
         7. 0 元酒店扣除授信里程活动 id 线下：zero.hotel.welfare.pay.mileage.id=1730
         8. 0 元酒店扣除授信里程活动 id 线上：zero.hotel.welfare.pay.mileage.id=1729
   3. 数据库表：
      1. tb_user_welfare_record - 用户权益领取记录
         1. 新增字段：
            1. detailId 里程明细 ID
            2. mileage_credit_limit 授信里程额度
            3. mileage_credit_return_flag 授信里程退还标识【1 - 已退还 | 0 - 未退还】



#### :full_moon:十一、里程拼手气红包后台

1. 将一份红包（一份红包中包含多个红包）发送给单个用户，用户再将红包发出去（个数为一份红包中配置的个数）
2. 开发：
   1. 分支：feature/zz/MileageRedPacket
   2. 数据库表（TEMallActAdmin）：
      1. mileage_activity_config：里程拼手气红包配置表
      2. mileage_coupon_list：单份红包信息



#### :full_moon:十二、[航司卡落历史erp订单号、发放状态、(券)核销状态](https://toca.17u.cn/cloud?fid=8907e306655c4715b02607389c00ace1&type=fileCreate)

1. 开发：
   1. 分支：fixbug/zz/airlineCardSaveErpNoV2



#### :zap:十三、[黑卡裂变](https://toca.17u.cn/cloud?fid=0e308d15c0b54fbf9c9c82d08520975e)

1. 券码等级直升活动
   1. 新增字段：
      1. 活动信息板块：
         1. 返利类型【1 - 贡献间夜 | 2 - 贡献里程】、背景色值、受邀方背景图、微信分享图、受邀方活动流程图、邀请方活动流程图、活动规则、活动类型【0 - 券码等级直升活动 | 1 - 黑卡裂变活动】
      2. 邀请方模块：
         1. 邀请次数更新周期【0 - 永久 | 1 - 邀请方等级周期】、高级名单用户账号、按钮文案、h5跳转链接、小程序跳转链接
      3. 受邀方模块：
         1. 风控验证开关、三要素验证开关、单向绑定验证开关、绑定开始时间、绑定结束时间、绑定状态【0 - 失效 | 1 - 生效】
2. 黑卡裂变高级名单
   1. 用户账号、邀请次数、名单名称、有效性
3. 开发：
   1. 分支：
   2. 数据字典：
      1. discount_type
      2. activity_type
      3. invitation_count_period_type
      4. share_type
      5. risk_check_type
      6. auth_check_type
      7. bind_check_type
   3. 数据库表：
      1. TCWirelessMemberCenterWeChat
         1. tb_coupon_shareactivity - 券码等级直升活动配置表
            1. 新增字段
               1. invitation_count_period_type：邀请次数更新周期类型【0 - 活动周期 | 1 - 邀请方等级周期】
               2. advanced_inviter_send_upperlimit：高级名单邀请次数
               3. invitee_background_color：受邀方背景色值
               4. inviter_background_color：邀请方背景色值
               5. invitee_background_image：受邀方背景图
               6. wx_share_image：微信分享图
               7. invitee_activity_image：受邀方活动流程图
               8. inviter_activity_image：邀请方活动流程图
               9. activity_rule：活动规则
               10. activity_type：活动类型【0 - 券码等级直升活动 | 1 - 黑卡裂变活动】
               11. button_text：按钮文案
               12. h5_url：h5跳转链接
               13. app_url：小程序跳转链接
               14. risk_check_type：风控验证开关【0 - 不验证风控 | 1 - 验证风控】
               15. auth_check_type：三要素验证开关【0 - 不验证三要素 | 1 - 验证三要素】
               16. bind_check_type：单向绑定验证开关【0 - 不开启单向绑定 | 1 - 开启单向绑定】
               17. share_type：分享名额类型【0 - 链接只可领取一次 | 1 - 链接可领取多次】
               18. advanced_list_code：高级名单编码
         2. tb_coupon_activity_discount - 券码等级直升活动返利类型配置表
            1. 新增表：
               1. activity_code：活动 code
               2. discount_type：返利类型【0 - 无 | 1 - 贡献间夜 | 2 - 贡献里程】
               3. 标准字段
         3. elite_circle_advanced_list - 黑卡裂变高级名单
            1. 新增表
               1. name：名单名称
               2. code：名单编码
               3. 标准字段
         4. elite_circle_advanced_account - 黑卡裂变高级名单账号
            1. 新增表
               1. list_code：名单编码
               2. account：用户账号
               3. account_type：账号类型【0 - mid | 1 - uid】
               4. 标准字段



#### :zap:十四、技术改造：openApi 站点鉴权

1. 分支：
   1. feature/zz/ChannelAuthenticationForOpenAPI
2. 背景：现在将每个渠道的鉴权信息放到 Redis 中，如果流量大的话会超时取不到鉴权信息
3. 优化：将信息放到统一配置中，从配置中取
4. 现逻辑：
   1. TokenService 中有两个流程
      1. 直接请求。会携带 HttpServletRequest 类型的参数，从该参数的请求头中直接获取 ChannelCode 和 SecureToken，进而查表获取用户的鉴权信息，并存到 Redis 中
      2. authorizationCodeCallback 接口回调。回调时只有 ChannelCode 一个参数，但是流程大致相同，根据 ChannelCode 查表获取用户信息并存到 Redis 中。
5. 优化逻辑：
   1. 不从 Redis 中取 auth，直接查询统一配置
6. 涉及到的表：
   1. bus_channel_api：接口信息表
   2. bus_api_info：接口权限表
7. 补充：
   1. 订阅 binlog 或者后台变更时，通过接口的形式将渠道信息推到统一配置中
      1. 订阅 binlog：两张表任意一张变更时都要订阅，有丶复杂
      2. 后台变更，共用一个方法
8. 实现步骤：
   1. 新增配置
      1. 新增的一定是未在配置中心里存在的，因此直接推送信息到配置中心
   2. 修改配置
      1. 修改时大概率是在配置中心里的，先校验在不在
      2. 如果不在直接推送更新
      3. 如果存在则删除配置中心里的数据，然后再推送
   3. 删除配置
      1. 删除时大概率数据在配置中心，先校验
      2. 如果不在则不执行操作
      3. 如果存在则执行删除操作
9. 注：pubapi 站点同样也用了在 Redis 中存数据鉴权的操作，其中的 key 前缀为：channel_token_






### 站点申请

1. Jean 平台中新建应用
2. 域名根据使用环境分为三种
    1. qa：测试环境
    2. stage：预发环境
    3. product：生产环境
3. 应用新建完成后需要申请实例资源，机器信息跟翔宇哥沟通。



### 三要素认证

1. 只有证件类型为身份证时，才会将姓名、手机号、身份证通过工信部进行认证（即三要素验证）
2. 如果证件类型不为身份证，只是进行信息的保存，不会进行三要素验证



### 权益列表

1. 会员中心权益列表页
2. 接口地址：welfare/getCategoryWelfares



### 权益表结构

#### 配置信息表（TCWirelessMemberCenterWeChat）

1. 权益信息：tb_welfare_info
   1. 信息表，无关联关系
2. 载体权益关联表：tb_carrier_welfare
   1. 中间表，将业务载体与权益通过载体标识和权益标识（非记录标识）进行关联
3. 载体策略关联表：tb_carrier_strategy
   1. 中间表，将业务载体、策略、权益通过载体标识、策略标识、权益标识进行关联
4. 权益发放策略信息：tb_strategy_info
   1. 中间表，将策略、权益、资源通过策略标识、权益标识、资源标识进行关联
5. 权益发放限制：tb_strategy_limit
   1. 策略关联表，将策略标识进行关联，有核销上限、核销周期有详细的字段
6. 权益图片：tb_business_image
   1. 权益图片信息表，权益附属

7. 注：一个权益会对应多个策略，但是一个权益 + 一个载体会对应唯一的策略

#### 记录表（TEMemberCenterWeChatPayment）

1. 用户载体领取记录：tb_user_carrier_record
   1. record_uuid：记录标识（随机生成）
   2. thirdparty_serialnumber：第三方序列号（如航司积分卡订单号）
2. 用户权益领取记录：tb_user_welfare_record
   1. record_uuid：记录标识（随机生成，关联 tb_user_welfare_resource_record 表，代表用户权益领取记录的唯一标识）
   2. 标识记录：权益标识、策略标识、业务载体标识
   3. 状态记录：权益发放状态、权益核销状态
   4. 类型记录：权益发放类型
3. 用户资源领取记录：tb_user_welfare_resource_record
   1. record_uuid：记录标识（随机生成，关联 tb_user_resource_record 表，代表用户资源领取记录的唯一标识）
   2. 标识记录：用户权益领取记录标识（welfare_record_uuid）、业务载体标识、权益标识、策略标识、资源标识
   3. 状态记录：资源发放状态、资源核销状态
   4. 类型记录：资源类型、资源发放类型
4. 用户资源充值记录：tb_user_resource_record
   1. record_uuid：记录标识（随机生成，但下游会用到，代表用户资源充值记录唯一标识）
   2. 标识记录：用户资源领取记录标识（resource_record_uuid）、资源标识
   3. 状态记录：资源发放状态、资源核销状态
   4. 第三方：第三方订单号（如 ERP 订单号）、第三方资源标识、第三方配置标识、第三方券码
5. 用户资源领取记录明细：tb_user_resource_detail_record
   1. record_uuid：记录标识（记录了 tb_user_resource_record 表，代表用户资源领取记录的唯一标识）
   2. 状态记录：资源发放状态、资源核销状态
   3. 第三方：第三方订单号（如 ERP 订单号）、第三方资源标识、各种更详细的券码信息



### 权益发放

1. 发放业务载体：

   1. 根据【业务载体 code】查询业务载体表【tb_business_carrier】，获取【载体类型 code】

   2. 根据【用户账号】和【账号类型】查询会员底层方法，获取【用户等级】和【用户等级分】

   3. 根据【业务载体 code】查询【tb_business_carrier_history】，获取【id】，作为用户载体领取记录里的业务载体快照存入

   4. 🌔根据【渠道 code】查询【bus_channel_history】，获取渠道相关信息。这里感觉应该是查【bus_channel】表获取渠道相关信息，【bus_channel_history】只用来获取【id】，作为渠道快照存入用户载体领取记录

   5. 其中【ThirdpartySerialnumber】可以放入自定义的订单号，如航司权益卡支付订单号。【StartTime】和【ExpiredTime】需要在代码里指定并计算。

   6. 将以上信息组装到实体，新增用户载体领取记录【tb_user_carrier_record】，载体发放成功

   7. ```java
       com.ly.member.service.notify.NotifyService#writeOffCarrier // 参考
      ```

2. 发放权益：

   1. 方法一：`welfareReceive`
      1. 校验载体类型、业务载体、渠道是否存在
      2. 🌔校验手机号变更次数、手机号是否绑定其他账号（需要传手机号，感觉是定制化的功能，需要确认一下，如果是的话重构时可以将该功能解耦）
      3. 🌔还有一堆莫名其妙的定制化校验，解耦的同时要把校验抽取到调用方
      4. 根据【权益 UUID】联表查询载体策略关系表【tb_carrier_strategy】、业务载体【tb_business_carrier】、策略信息【tb_strategy_info】，获取权益挂载的策略和策略挂载的载体，组装为策略集合DTO，同时校验该对象是否为空（即权益是否关联了策略、策略是否作用于载体）
      5. 艺龙酒店权益 UUID 是否与当前发放的权益 UUID 相匹配，不匹配则需要走先知判断流程
      6. 根据策略DTO判断是否配置了先知标签，如果配置了先知标签则根据传入的用户信息校验该用户是否符合先知人群信息
      7. 🌔根据【权益 UUID】查询权益策略关系表【tb_strategy_relation】，获取当前权益挂载的策略类型，并标记该权益挂载的策略是否存在附属策略，同时组装策略权益集合DTO（权益策略关系表应改名为【tb_strategy_welfare】，是权益与策略关联关系）
      8. 根据【业务载体 code】联表查询载体权益关联表【tb_carrier_welfare】、权益信息【tb_welfare_info】，获取当前载体关联的权益，组装为载体权益集合 DTO
      9. 特殊校验：
         1. 艺龙0元酒店权益 UUID 是否与当前发放的权益 UUID 相匹配，不匹配则需要走先知判断流程
         2. 🌔当前发放的权益 UUID 与艺龙0元酒店权益 UUID、机场贵宾厅权益 UUID 对比，且二者互斥，走独立的流程，有单独的逻辑，需要单个处理、总结逻辑并拆分出来
   2. 方法二：`affiliatedWelfareReceive` 策略权益集合DTO存在附属策略（权益）支线
      1. 🌔二次校验策略权益集合DTO是否真的存在附属策略（重复校验，可以拿掉），从策略权益集合DTO中提取主策略集合
         1. 遍历主策略集合，通过【业务载体 code】和主策略集合中的【策略 UUID】联表查询载体策略关系表【tb_carrier_strategy】、业务载体【tb_business_carrier】、策略信息【tb_strategy_info】，获取唯一对应的策略，组装为策略 DTO，并将该 DTO 标记为当前策略对应的主策略
   3. 方法三：`welfareReceive` 策略权益集合DTO不存在附属策略（权益）支线
      1. todo

3. QA：

   1. 业务载体中的第三方关联 ID 的作用
      1. 会员等级在数据流转中也属于一种载体
      2. 仅当业务载体类型为会员等级时该字段生效，会向用户发送第三方关联 ID 对应的会员等级载体（1、2、3、4 - 普银金白会员等级身份）



### 2024年8月30日 星期五

#### 待办：

#### 日程：

1. MySQL 分片、表结构。
    1. AviationMember 航司会员表
2. MQ 内核（RocketMQ）。
3. 【会员后台】SOP 操作文档。
4. 新建站点（以新建航司积分接口为例）
    1. Jean 操作平台中新建应用
    2. 应用配置正常填写
    3. 后期需要修改 DockerFile



### 2024年9月2日 星期一

#### 待办：

#### 日程：

1. 主要还是看业务具体的实现逻辑，最基本的 CRUD 怎么实现，如查库查表、写缓存、读配置、模块间调用、跨模块间调用等，熟悉公司的研发后台。
2. 以商城项目的 tcwireless.java.member.shop.admin 站点为例
    1. 在 skyeye 中了解该站点的接口负载明细。
    2. 缓存组件 TcCacheClient 的使用
        1. 并发锁：DISTRIBUTED_LOCK
        2. 高可用缓存：MALL_COMMON
    3. 消息队列 TurboMQ 的使用，包括生产者、消费者、主题与 Broker 之间的调用关系及流程，但是需要了解主题的建立规则。
3. 会员体系、ERP 系统、鲲鹏系统的培训说明。



### 2024年9月3日 星期二

#### [需求：新增航司历程会员权益](https://docs.qq.com/doc/DR0RMR2VQY2xuSkFB?u=48a9d48d2a194bf2bc20897750239305)

##### 1、会员后台资源管理新增航司里程资源

1. 手动添加配置（添加权益规则）
    1. 包括航司名称、发放系数、发放的积分额度上限、会员等级系数
    2. 其中订单航司积分奖励 = 国内机票实付金额 * 发放系数 * 会员等级系数
    3. 注：积分发放最小单位是 10 积分，不满 10 积分的部分向上取整，以 10 积分计入
    4. 通过前端入参保存配置到 airline_point_config 表中。
2. 查看配置
    1. 全量查询 airline_point_config 表中所有已保存的配置，且可以根据航司名称模糊查询。
3. 使用配置
    1. 上游业务需要根据配置进行积分计算等业务操作时，需要传入如航司名称或航司唯一 ID 进行获取，因此需要向外暴露一个接口，并返回保存的配置信息。
4. 疑问：
    1. 航司对应的 ID 怎么取



### 2024年9月4日 星期三

#### [需求：新增航司里程会员权益](https://docs.qq.com/doc/DR0RMR2VQY2xuSkFB?u=48a9d48d2a194bf2bc20897750239305)

##### 1、航司里程发放策略配置和管理

1. 新增、修改配置功能
    1. 包括字段：配置 ID、渠道 ID（默认是会员权益？）、航司名称、航司唯一标识 ID、上限额度（根据 RPC 查询）、是否发放一致性、是否出行人一致性。
    2. 里程触发发放条件存疑。
    3. 发放系数取值方式存疑。
    4. 配置风控策略存疑。
    5. 新建航司里程发放策略配置表，保存配置。
2. 根据会员等级和航司 ID 查询上限额度
    1. 新建航司额度上限表，包括字段：会员等级（冗余字段）、会员等级枚举、航司 ID、航司额度上限。
    2. 提前 INSERT 将额度数据写入表中。
    3. 向外暴露一个接口，提供查询功能。
    4. 当在配置页面选择会员等级时，会查询出对应的上限额度。
3. 疑问：
    1. 航司的最大发放额度跟会员等级关联吗？目前在运营文档中描述发放积分奖励与会员等级相关。



### 2024年9月5日 星期四

#### 日程：熟悉 ERP 资源管理系统

1. 渠道管理（划分不同的业务）
    1. 所属项目：属于哪个 BG 运营
    2. 渠道名称：用来区分不同的业务
2. 产品管理（定性）
    1. 产品 ID：相当于 SPU ID，单个产品的唯一标识
    2. 产品分类：根据业务进行区分
3. 资源管理（定量）
    1. 资源是产品的量化体现，因此需要挂在具体的产品下。
    2. 产品与资源是一对多的关系，一个产品可以对应多个资源。
    3. 资源 ID 相当于 SKU ID，单个资源的唯一标识。
    4. 产品相同，资源不同，意味着可能资源间的库存不同、渠道不同、成本归属不同等因为业务原因进行不同规格的分解。
    5. 资源类型
        1. 实物。 
        2. 虚拟卡券
            1. 直接通过卡密直接进行兑换相应的资源。
        3. 虚拟充值
            1. 充值到第三方如网易云音乐，也可能是第三方接口返回券码、卡密再进行充值



### 2024年9月6日 星期五

#### 熟悉商城管理系统

1. 所有的商品都是基于 ERP，每个商城订单在 ERP 都会有一个订单。
2. 商品库
    1. 商品 ID：商城系统单独生成的唯一标识，与其他系统不互通。
    2. ERP 产品、资源 ID：与 ERP 系统里的产品与资源相对应。
3. 商品基本信息
    1. 关联的 ERP 产品名称、ERP 产品 ID、ERP 资源类型、商品自身的 ID
    2. 可选商品投放的平台：如 APP、小程序，可以达成平台不同，定价、库存、支付方式等同一商品的不同配置。
    3. 可选商品的兑换方式：如里程支付、现金支付、混合支付、无（代表三者支付都可选）



### 2024年9月9日 星期一

#### 需求一



#### 会员系统培训

1. 领券中心、会员中心、浮层、会员权益、红包治理策略、挑战任务（公共平台）、会员任务（会员平台）



### 2024年9月10日 星期二

#### 需求一



#### 笔记

1. 顺序
    1. **PO 实体类**
    2. **Mapper 接口**，继承 BaseMapper 并在泛型中放入新建的 PO 实体类
    3. **Mapper.xml 文件**，映射 PO 实体类、Mapper 接口
    4. **业务实现类**，聚合 Mapper 接口
    5. **Controller 层**，聚合业务实现类



#### 沉淀

1. Mybatis 进行 INSERT 操作时，出现主键不从 1 开始，反而是一个很大且不规律数字的现象
    1. 数据库表主键 ID 本身设置了自增。
    2. `@TableId(value = "id", type = IdType.AUTO)` 添加至实体类的主键。
    3. 如果已经按照 Mybatis 生成的 ID 自增了，需要用到 truncate table 关键字来清空数据库，重置主键。
    4. 其中添加注解的目的是忽略 Mybatis 生成的主键，转而使用数据库自增的主键。



### 2024年9月11日 星期三

#### 需求一

1. 第一列 ID 展示的即为主键 ID

2. 航司积分配置是与航司配置关联的，因此航司唯一标识根据航司名称需要从 airline_config 表中去取 ERP 充值 ID 字段（interface_id）。

3. 当使用了别的 BG 提供的字段枚举值时，需要根据对面提供的文档自行维护。

4. 出行状态（订单状态）字段枚举值：

    1. ```txt
        【0 - 草稿 | 1 - 下单取消 | 2 - 待支付 | 3 - 已支付 | 4 - 预定中 | 5 - 已预订（外显示待出行） | 6 - 待点评 | 7 - 退款中 | 8 - 已退款 | 9 - 已结束 | 10 - 待审核 | 11 - 待付款 | 12 - 付款中 | 15 - 变更中 | 16 - 退票完成 | 19 - 待跟进 | 20 - 已废弃】
        ```

5. 出现 Maven 插件错误时，修改 Maven 版本和修改 conf 文件都是无效的，需要手动去本地仓库删除下载错误的依赖，并刷新 Maven 重新下载。

    1. 如：org.apache.maven.plugins:maven-site-plugin 报错时，根据包名依次进入文件夹，找到 site 插件即可。



### 2024年9月12日 星期四

#### 提测流程



#### 会员系统 - 业务载体

1. 业务载体类型：分属不同的业务场景，是最大的一个分类
2. 业务载体信息：对业务载体类型进行细分，如载体类型为会员，标准的业务载体信息包括普银金白



#### 会员系统 - 权益管理

1. 权益分类
    1. 主标题：展示在会员权益列表页中，主标题即为最主要展示的样式，主要是描述对应的业务
    2. 按照排序大小展示分类的先后顺序
2. 权益配置
    1. 权益配置需要挂在权益分类下面
    2. 标题：图标旁的大字为主标题，小字为副标题（优先展示剩余次数，无剩余次数展示副标题）
    3. 权益适用展示：
        1. 按配置文案展示：需要配置对应的会员等级是否解锁该权益、该权益的享用次数
        2. 不显示：不限制会员等级和次数
        3. 按策略展示：按配置的策略展示（相当于更高级的展示方法，会有更多的场景展示条件）



#### 会员系统 - 策略管理

1. 策略配置
    1. 绑定权益：指定该策略对哪个具体的权益生效
    2. 绑定资源：如果该权益会有实体或虚拟充值券，则需要指定对应的资源
    3. 可以控制权益的展示和领取的平台
    4. 可以配置按钮的文案和跳转链接
    5. 可以理解成对权益更详细的控制与定制化。



#### 会员系统 - 资源管理

1. 资源基础信息
    1. 如有些权益可以领立减券，那么就可以挂载对应的资源。
    2. 可以配置资源来源、资源类型以及是否第三方渠道、资源链接（如使用券）
    3. 可以配置资源的结算方式、生效期、库存预警等



### 2024年9月13日 星期五

#### 新人培训



### 2024年9月14日 星期六

#### 新人培训

1. 星程计划各种任务



### 2024年9月18日 星期三

#### 新增航司里程会员权益需求

1. 后台查询权益发放情况



### 2024年9月19日 星期四

#### Mybatis Plus 多数据源查表规范

1. 原理：
    1. config 配置每一个数据源的 Bean
    2. 在配置文件中设置扫描 mapper 接口的位置，并设置对应的 mapper xml 类路径，因此不同库的查询需要放在不同的包下
    3. 相应的配置下面会有分页插件
2. 规范：
    1. Mapper 接口、PO 类、Mapper XML 都需要放在指定库的包下
3. 在 logback-spring 配置 Mapper 接口的位置，查看具体的 SQL 语句日志，如：<logger name="com.ly.mall.admin.adapter.mappers" level="DEBUG"/>



### 2024年9月23日 星期一

#### 新增航司里程会员权益



#### 里程优享卡提供外部里程额度相关接口需求



### 2024年9月24日 星期二

#### 待办

1. 完成补发积分的后端接口，根据传的主键 ID 和补发积分更新相应的明细即可（注意校验参数）
2. 拿掉里程积分扣减活动字段的注解必填校验



#### 环境发布

1. 管理系统前端打包时，需要在指定的环境分支（如 QA）下执行 npm run build:qa



#### 航司里程发放策略配置和管理

1. 航司配置页面新增会员等级筛选



### 2024年9月25日 星期三

#### 里程卡券码发送企业邮件需求



### 2024年9月26日 星期四

#### 里程卡券码发送企业邮件需求

1. 因为是分片库，因此查询券码明细需要在 ES 中查询



### 2024年9月26日 星期五

#### 待办

1. 根据 ES 的滚动查询方法 getGradeCouponCodeFromEsScroll 查询出所需的券码明细，可以根据当前页参考该方法和后续 getGradeCouponCodeFromEsScrollNext 方法的使用。
2. 如果单 excel 超过 5000 条，就再生成一个 excel



### 2024年10月10日 星期四

#### 【联名会员】联名会员需求迭代

1. :moon: 集团列表页、等级页、平台页是三个不同的表，现要求取三个表中的字段展示并增加筛选条件。
   1. 因为是后台配置页面，可以进行三张表联表查询，但是考虑到如果以后需要展示更多的字段（如展示权益或者新功能），可能会 join 更多的表，不利于扩展，也不利于性能。建议是有些没必要的字段不必展示，如果一定要展示，就要考虑到以后的是否还会去扩展。
2. 其余排序只是在单表上增加优先级权重字段，无影响。
3. :moon: 联名会员 - 更多推荐：点击是否有效滑块时，对应的集团同样的置为同样的状态
   1. 技术上，更多推荐模块与集团列表页模块无关联，因此技术上无法实现，需要从业务上给予一定的联系。
   2. 业务上，暂时没有二者之间的业务联系，需要产品支持说明。



### 2024年10月14日 星期一

#### 【联名会员】联名会员需求迭代

1. 更多推荐的配置平台直接复用 ME_CompanyPlatform 表，其中有 company_ident 继续存推荐卡标识。理解上，将该表扩展为专门配置平台的表，而非专属于集团的下属明细表。



### 2024年10月15日 星期二

#### 里程卡券码发送企业邮件 Bug

1. 发送邮件时置为当前批次有效走的是原逻辑。如果再次点击时会置为无效，因此需要判断当前批次已经有效的话，就不用再走置为有效的原逻辑了。
2. 渠道配置中可以配置企业邮箱地址，添加可修改的功能。

#### 联名会员需求迭代

1. 用户互通数据列表页新增字段：激活来源。需要详细的存取逻辑
2. 数据埋点问题：
   1. 前端可能已经完成，需要看下前端是在哪个接口加了参数
   2. 在 RPD 中给了落表的数据库表 TCWirelessMemberCenterWeChat.tb_thirdparty_membership_relation，需要明确为什么给这个表，以及怎么落表



### 2024年10月16日 星期三

#### 联名会员需求迭代

1. 互通数据是新数据，不再使用互通记录
   1. 互通数据：TCWirelessMemberCenterWeChat.tb_member_exhange_record
   2. 互通记录：TCWirelessMemberCenterWeChat.tb_thirdparty_membership_relation
2. 互通数据表新增字段 refId



### 2024年10月17日 星期四

#### 里程卡券码一键发送企业邮件

1. 预发环境复制激活链接有问题
2. 产品新增修改
3. 分支已修改邮件地址发送问题，还没有合并



### 2024年10月18日 星期五

#### 联名会员需求迭代

1. 发环境



### 2024年10月21日 星期一

#### 里程卡券码一键发送企业邮件

1. getGradeCouponCodeFromEsScrollNext() 方法查出来的数据只有 10 条，现在需要一次性查出多条，有没有方法
   1. 整个接口异步执行，前端立刻返回成功标识，但会存在异常无法及时抛出的风险



#### 【联名会员】联名会员需求迭代

1. 集团和更多推荐有平台配置的功能，现在需要将平台配置同步实现在用户端的显隐上



#### 权益卡外部接口能力



### 2024年10月23日 星期三

#### 权益卡外部接口能力

1. 梳理一遍需求



#### 【联名会员】联名会员需求迭代

1. 上线，stage 测试、验收完毕



#### 请假！

1. 去上海，搬家！



### 2024年10月25日 星期五

#### 权益卡外部接口能力

1. 收尾！



### 2024年10月28日 星期一

1. 通过渠道获取到三级归因编码，然后再用三级归因编码去查询系统字典数据进而获取三级归因名称，具体可参考方法 `String getChannelThirdDimensionName(Long param1)`
2. 体验卡和里程优享卡的区别



### 2024年10月29日 星期二

#### 权益卡外部接口能力

1. 淦，需求又变更



#### 商城首页改版

1. 开整新需求



### 2024年10月30日 星期三

#### 商城首页改版

1. 主标题：必填，且最多不超过 10 个中文字符



### 2024年12月24日 星期二

#### 待办

1. 航司积分卡ES写入数据，测试字段是否能写进去
   1. 已发 QA
2. 0 元酒店权益需求，新建测试环境的权益，并将所有配置项写入配置文件
   1. QA 环境填的线上权益 ID
3. 星耀白名单激活后台，逻辑清理
   1. 差不多行了
4. 里程拼手气红包后台开发
   1. 差一点点细节



### 2024年12月25日 星期三

#### 待办

1. 插入需求：https://matrix.17usoft.com/v2/matrix-web/project/pjt2060#/requirementPool/237186 
2. 二选一存在用户需求处理



#### 2024年12月30日 星期一

#### 绩效自评

1. 成绩与心得体会
   1. Q4一整个季度是入职之后第一个完整的季度，中间穿插着各种产品需求、OKR任务、优化任务，总体来说感觉非常充实，这一个季度收获与成长也是非常多。往小里说，就是开始适应开发规范、开发流程、对接注意事项，也逐步提高了开发效率。往大里说，开始了解会员业务的底层流程，表数据之间的流转，不再像刚入职一样，看着后台满满的字段但是脑子里没有成体系的系统流程。
   2. 另一点也是因为参与了一整个大需求，虽说完成的不是很完美，但是也促进形成了在新环境中排查问题的思维，可以了解到自己涉及业务的客诉原因，以及解决方法。而且不止与解决客诉，而是找到后面的问题，通过技术手段尽量减少诸如此类问题的出现。
2. 不足及改进计划
   1. 复盘每次做的需求，其实会发现开发时间占比并不高，最高的是去理清PRD的设计逻辑，并到以前的代码或者业务中去校验该逻辑是否合理，或者该逻辑是否已经存在。以发放权益功能举例，是会员这边核心的功能，经过很多人的迭代，自己因为对业务不熟悉需要大量的时间去理解，因此计划在理解的基础上进行重构，解决自己业务理解偏差的同时，也能为以后的业务扩展铺好道路，节省开发时长。
   2. 业务覆盖量不够，无法对PRD提出有效的改进意见以达成高质量上线的目的，不管是时间和质量上都有很大的问题。在以后的需求任务中，尽量的提前多准备，也可以省去以后确认细节、确认逻辑的时间，并输出现在空缺的一些文档，让不理解业务的自己或以后的同事可以尽快上手。

#### 修 BUG

1. 航司积分卡退款时，正常会将用户载体领取记录置为无效，但是偶发影响到其他订单的领取记录，初步认为是过滤条件有问题，已修复。



### 2025年1月2日 星期四

#### Q4 复盘

1. 简介：
   1. 主要负责会员业务的需求开发与功能优化，如里程优享卡、航司积分卡、星耀会员等比较大的需求，前期偏重于后台开发，在季度后期逐渐开发业务向的功能点。
   
2. 关键任务达成情况
   1. OKR
      1. 旧里程开放平台功能向新平台转移
         1. 后端部分业务不会变更，因此迁移时只考虑代码兼容性即可，小部分需要额外的处理（旧里程站点使用的依赖版本是 springboot 1.5.21），因此迁移时在写法上会有一定的改动，但是不会牵扯到业务层面，目前进行了接口总览的梳理，未进行完全的迁移
         2. 前端没有使用 vue 2.x 框架，因此转移时基本会重构整个页面（页面与现阶段的商城模式靠拢），跟后端相同，没有业务层面的改动，因此页面、js 接口只是进行迁移加小改动，目前主要处在后端部分
   2. 初步上手
      1. 从完成最开始的里程优享卡需求开始逐步接触会员业务，在之后接了联名会员的简单迭代的需求，从会员的边缘开始慢慢的理解业务方向和上手开发的模式
   3. 熟悉业务
      1. 开始合作开发航司权益需求，主要熟悉从支付完成到权益主流程的业务
   4. 需求开发
      1. 星耀一期二期需求开发，对 C 端权益有更多的了解
   
3. 工作亮点
   1. 权益支付回调流程
      1. 在开发航司积分卡需求时，有涉及到金额的支付回调和权益发放后续业务，在开发时打算借鉴省钱卡的回调逻辑，但是功能基本是耦合在一起的，无法单独使用某个功能点或者进行拆分，还有多处魔法数字，因此在完成需求时，进行了细小功能点的拆分，方便以后其他载体或权益进行扩展
      2. 将流程中相对公共的部分进行了拆分，整体流程分为了从响应支付回调开始
         1. 前置校验
            1. 回调一致性处理，在业务处理过程中，有且只能有一个线程可以进行此次支付的回调，其余线程进行拦截处理
            2. 回调参数校验，基本的参数校验，封装即用，不用再根据财务文档进行重新进行各个参数的校验
            3. 财务交易二次校验，主业务处理前再次确认是否财务侧已收到款项，并优化了各种魔法数字精简了流程，只关注财务校验是否通过
         2. 业务处理
            1. 业务一致性处理，在业务处理完毕后，意味着该流程已经结束，因此所有的回调都进行拦截
            2. 根据业务类型发放对应的载体，之后可以补充自己业务功能的逻辑（权益的主流程、自定义校验规则、各种状态的变更）
         3. 异常处理
            1. 可以根据抛出的异常类型如 CustomException 或者 Exception 等走不同的处理逻辑（退款或继续主流程）
            2. 其中退款流程因为业务不同未进行功能的拆分（如创退款单、释放库存、发起退款、退款回调等，是后期需要进一步优化的点）
   
4. 个人成长
   1. 客诉流程
      1. 第一次处理的客诉问题不是很复杂，但是也由此得知功能的哪个点是有问题需要人工处理的，后续需要出方案去优化，在此之前，需要通过日志核实信息和数据并解决客诉首要的诉求
   2. 需求信息提取
      1. PRD写的内容杂而多，需要从中间筛选出所需要开发的功能点、运营的原始需求、系统现有的逻辑，而且在开发过程中需要不停的确认或优化细节，所以在这个过程中不只是精炼需求，还会要求自己去熟悉当前的系统逻辑是否已经存在，或者需求的设计是否跟现有的系统逻辑冲突等，也算是逐步掌握业务逻辑的过程
   3. 会员业务逻辑梳理
      1. 在开发整个航司积分卡需求及复盘之后，对会员业务底层的权益层面有了更深的理解，不同于刚入职培训时记录的简短的笔记，实际开发的时候会涉及整个权益发放的主流程，从业务载体到最后的领取记录，以及其中与 ERP 的对接等都是在笔记里无法体会到的。特别是在开发过程中与第三方的联调与交涉方面，也是有了很大的提升
   
5. 总结
   1. 7 分
   2. 总体来说，基本达到自己的预期，在会员业务开发的时候也遇到了很多磕磕绊绊，随着需求的开发，在团队协作、开发流程、代码风格方面都有了较大的提升。
   3. 最开始简单的后台开发时没有成体系的理解每个模块甚至于每个字段的含义，无法与现有的业务逻辑贴合在一块，直到后面深入到确切的场景和需求时才有了自己的认识，这个成长也伴随着低效率和高 bug 率，在这里试错过程中也体会到了整个团队的包容。对于开发而言还有很大的提升空间，算是一个不错的开始，也是成长飞快的一个季度。
   
6. 工作计划
   1. 需求理解
      1. 复盘整个季度，需求评审、提炼、确认细节方面所花费的时间占很高的比重，其中一方面是自身对系统业务的不熟悉，在评审时只有大概的理解，无法立即提出相应的意见，需要在会后确认存疑的细节。确认的细节需要建立在现有逻辑基础上，是需要重构、新开发、简单修改还是其他需要自己梳理以前的逻辑，然后在开发基础上不断的去完善细节，这样势必会有考虑不全或者遗漏的现象，所以在以后的需求开发中，需要预先了解所涉及的业务，不在确认以前逻辑上花大量的时间
   2. 发放权益梳理
      1. 原发放权益经过多人的迭代，有很多定制化的流程，无法很好的在后续的功能开发中进行扩展，而且发放权益又是比较核心的功能，因此计划对整个发放权益的流程进行梳理（涉及 user、common、open 三个实现类），能公共实现的方法就尽量抽出来，定制化的流程尽量用设计模式去解耦，而不是整合在一个业务方法中。不管是在以后的开发还是排查问题时都有帮助，但调用的原逻辑很多，内部的调用也很复杂，因此重构是一个很大的挑战，计划在后面先梳理每一层的逻辑和特殊流程，在重构后不影响现有的业务
   
   

### 2025年2月6日 星期四

1. bug 修改
   1. :full_moon:fixbug/zz/checkZeroHotelThreeAuthInfo
      1. 错误点：自动发放资源失败，手动领取资源时会走 0 元酒店的实名校验导致报错
      2. 修改：添加 0 元酒店权益校验
   2. :full_moon:fixbug/zz/airlineListMemberLevel
      1. 错误点：后台添加航司配置时，兑换比例不填会空指针异常
      2. 修改：兑换比例字段设置为必填项



### 2025年2月11日 星期二

1. 需求
   1. 背景色值改为两个字段，一个是邀请人背景色值，一个是被邀请人背景色值
2. 待办：
   1. 高级名单账号新增时要做去重校验



### 2025年2月13日 星期四

1. 技术改造
   1. openapi 鉴权走 Redis，如果流量大的话会超时，因此考虑改造一下
      1. 走内存处理
      2. 接统一配置的推模式



### 2025年2月14日 星期五

1. GC 导致 Redis 执行命令超时



### 2025年2月15日 星期六

#### 消息堆积问题

1. 初步排查步骤
   1. 消费者组 marketing_member_group_member_grade 订阅的 marketing_member_center_topic_membergrade 出现消息堆积
      1. 个别客户端堆积，非整体堆积，因此最先排除 Broker 问题
      2. 追溯对应的 topic，可以看出生产情况没有暴增或急剧的变化，生产消息曲线平稳，因此排查生产者方问题
      3. ![image-20250225114224353](D:\riven code\Note\Experience\assets\image-20250225114224353.png)
   2. 然后到消费者组 marketing_member_group_member_grade 中溯源问题
      1. 代码最近没有提交记录，因此排除最近业务迭代问题。
      2. 初步推测是数据库写入有问题，导致消息消费异常。在慢 SQL 日志中没有找到与该类 checkUserCarrierRecord 相关的记录，继而开始发呆懵逼。但同样发现产生了很多慢 SQL 语句，排查起来比较费劲，很久才定位到慢 SQL 的位置是 GMGroupService 类中在写 tb_member_exhange_record 表。当时推测慢 SQL 与消息堆积是两个独立问题，因此没有关联排查。
      3. ![image-20250225114411362](D:\riven code\Note\Experience\assets\image-20250225114411362.png)
   3. 慢 SQL 的位置是 com.ly.member.datasource1.memberexchange.mapper.TbMemberExhangeRecordMapper#selectTbMemberExhangeRecordList 198 行。根据执行计划得知走了全表扫描，其中 where 条件中的两个字段离散度不高，加索引 的话意义不大（找到慢 SQL 的代码位置太难了。。。。。。。。。。。。。。。费半天事）
      1. ![image-20250225114453422](D:\riven code\Note\Experience\assets\image-20250225114453422.png)
   4. 然后在 Redis 日志中发现大量报错信息，一开始以为是 Redis 重连建立链接超时，后经过判断，是频繁 GC 占用了大量 CPU 资源，导致流程执行响应变的极慢，造成 Redis 执行命令超时（超过规定的 2s），也就因此产生了以下报错的信息。
      1. ![image-20250225114519493](D:\riven code\Note\Experience\assets\image-20250225114519493.png)
   5. 以前遇到过 Redis Lock 组件问题，因此尝试更换组件的注入的 Bean，但是没有产生效果，而且实例处于高负载情况，下负载困难，在发布上也占用了大量的时间。
   6. 另外不止在消费者组，在 MqUserWelfareResourceRecordHandler 订阅 binlog 同步 marketmembercenter-resourcerecord 文档时也出现了执行 Redis 命令超时的错误。
      1. ![image-20250225114549837](D:\riven code\Note\Experience\assets\image-20250225114549837.png)
   7. 经翔宇哥屏蔽无意义的慢查询后，长链接释放，JVM 内存和 CPU 逐渐开始恢复正常，消费者恢复到正常速度消费
      1. ![image-20250225114613881](D:\riven code\Note\Experience\assets\image-20250225114613881.png)
2. 推测（以当时高负载机器为例）
   1. 大量慢查询请求过来时，内存中堆使用情况拉高，且存在频繁释放的问题
      1. ![image-20250225115002071](D:\riven code\Note\Experience\assets\image-20250225115002071.png)
   2. 根据指定的 JVM 参数："-XX:NewSize=1792m","-XX:MaxNewSize=1792m"，可知 Survivor 区大小为 180M 左右，且老年代空间异常拉高且不足。出现的原因应该是慢查询执行时间过长，导致 young GC 频繁，且 GC 后存活对象过多，
      Survivor 区拉满，导致老年代空间占用过高，进而造成频繁的 full GC，而且频繁 full GC 时会导致处理其他请求的线程变慢，如本次的 Redis 执行命令超时，所以源头基本是指向此次的慢查询
      1. ![image-20250225115037743](D:\riven code\Note\Experience\assets\image-20250225115037743.png)
      2. ![image-20250225115057348](D:\riven code\Note\Experience\assets\image-20250225115057348.png)
3. 优化排查方向
   1. 消息堆积报警中，非所有机器都在堆积，会有个别堆积峰值机器，因此在排查时，可以拿该机器的 IP，并在 APM JVM 机器性能中查看各项指标，而非在 APM 中查看所有的机器性能曲线造成误判，也可以更快的定位问题。
      1. ![image-20250225115129028](D:\riven code\Note\Experience\assets\image-20250225115129028.png)
   2. 消息堆积上游一般是消费者出问题，消费者的上游一般是写库出现异常（如 MYSQL 大量死锁、全表遍历、DDL 过多过长占用链接等），虽然慢 SQL 没有出现在消息堆积的消费者组，但不应该立马否定二者没有关联。
   3. Redis 执行命令超时是被影响的结果，不应该在这上面耗费大量的时间，且已知是频繁 GC 导致的，因此需要找到频繁 GC 的问题。又因为已经有慢 SQL 出现，所以应该将该情况与频繁 GC 联系起来进行排查。





### 2025年2月17日 星期一

#### 1、技术改造：openApi 站点鉴权

1. 初步开发



### 2025年2月18日 星期二

1. token 审核获取，然后走接口调用测试
2. 参数中 group 的概念：仅限于页面上维护使用，不更改 key 本身
3. 状态置为公开时，别的项目才可以修改此配置



### 2025年2月25日 星期二

1. 航司权益卡
   1. 展示、下单、金额支付、里程扣减、落表、发放权益和资源、更新状态或自动退款
   2. 动态分层、精准权益、积分激励等设计
   3. 用户增长会员部分
   4. 航司积分权益卡
      1. 参与设计开发 C 端航司积分权益卡活动，为指定会员等级提供多项精准权益，并将航司积分以兑换和赠送的形式发放给客户，同时可使用同程里程积分抵扣，增加高净值用户粘性和忠诚度
      2. 功能包括 C 端用户订单、航司积分权益的展示与交互、支付回调后的权益发放、相应账户的里程扣减，发放核心权益的同时订阅 binlog 的形式双写 ES 记录用户权益的领取记录并发放对应的资源至用户账号
      3. 大数据量展示信息类型接口通过 MYSQL 与 ES 进行数据聚合，在聚合中开启多线程进行数据整合，减少单链路执行时间，提高 ES 处理吞吐量，减少接口耗时
2. 黑卡会员权益相关
   1. 黑卡等级会员
      1. 在底层会员基础上新增会员等级，主要面向公司定向邀请人群和数据中心推送的高 GMV 用户，联合机票、酒店、度假等提供专项高价值的权益（如 0 元酒店、邀好友升白金等级、周周咖啡礼等）
      2. 高等级会员权益与资源绑定较多，在原基础等级会员权益基础上，使用策略模板模式，针对权益做特殊逻辑和资源的前置处理，如风控校验、三要素校验、不同资源系统的权益发放
      3. 同 BG 内黑卡等级会员接口调用较多，且鉴权信息存储在 Redis 内，监控时发现造成单次鉴权网络流量过大，出现大 Key 问题，因此通过技术改造将鉴权信息通过 API 推送至统一配置中心管理，减轻 Redis 压力
          1. **可以表示为解决 Redis 大 Key 问题，进行 Key 的拆分。如首先是将业务 Redis 与大 Key 使用的 Redis 进行分离，避免对主要业务产生影响。其次是根据知识进行 Key 的拆分、鉴权后台的新增、账户的管理等等**
      4. 权益与资源表数量相对较多，且变动较少，但在用户查询权益或领取权益时频繁查询，因此将权益、资源、策略进行 JSON 化处理，通过定时任务定期将权益结构放到 Redis 中统一查询，减少大量的 Join 查询与 MYSQL 链接
3. 技术优化
   1. 鉴权修改
   2. 责任链模式
   3. 策略、模板模式



### 消息队列重复消费问题

#### 出现消息重复的场景

1. 生产者发送消息给 broker，但是没有成功返回给生产者 Ack，生产者以为消息没有投递成功，因此会重试再次给 broker 发送同一条消息。此时 broker 会保存多条同样的消息，导致消费者重复消费。
2. 消费者消费消息后，给 broker 发送 Ack 失败，使 broker 误以为消息推送失败，此时 broker 会再次推送消息给消费者，造成重复消费。

#### 生产者、Broker 防重

1. 只能通过修改中间件的配置

#### 消费者防重（主要在服务端控制防重）

1. 业务层幂等设置
    1. 一般消息体内会有业务唯一 ID（如订单号、用户账号等），消费前校验是否已经修改过了状态
2. 分布式锁控制
    1. 使用 Redis 的 SetNX 命令，使唯一 ID 为 Redis 的 key，消费者如果能获取到锁则说明未消费，但是要设置合理的 TTL 时间，一般为整个消息消费的业务执行时间。

